################################################################################
# Testing template for phpunit, this provide Apache / Php.
################################################################################

.test_template:
  extends: 
    - .variables_test
    - .artifacts_reports
  dependencies:
    - build
  services:
    - mariadb:latest
  before_script:
    # Start Apache.
    - apache2-foreground&
    # Prepare ci (mirror files in Docker image doc root).
    - curl -fsSL ${CI_REMOTE_FILES}/RoboFile.php -o RoboFile.php
    - echo -e "\e[0Ksection_start:`date +%s`:test_ci_prepare[collapsed=true]\r\e[0K\e[1;34mRobo ci:prepare, set tools registries"
    - robo ci:prepare
    # Support composer mirrors and token.
    - if [ ! -z ${COMPOSER_REPO_PACKAGIST_URL} ]; then
        composer config --global repo.packagist composer ${COMPOSER_REPO_PACKAGIST_URL};
      fi
    - if [ ! -z "${COMPOSER_GITHUB_OAUTH_TOKEN}" ]; then
        composer config -g github-oauth.github.com ${COMPOSER_GITHUB_OAUTH_TOKEN};
      fi
    # Support Yarn registry mirror.
    - if [ ! -z "${YARN_REGISTRY}" ]; then
        yarn config set registry ${YARN_REGISTRY};
      fi
    # Set permissions for tests.
    - mkdir -p ${BROWSERTEST_OUTPUT_DIRECTORY} &&
      chown -R www-data:www-data ${BROWSERTEST_OUTPUT_DIRECTORY} &&
      chmod -R 777 ${BROWSERTEST_OUTPUT_DIRECTORY}
    # Added phpspec for Drupal 9.0+, @see https://www.drupal.org/project/drupal/issues/3182653
    # @todo: remove when 8.9 is deprecated.
    - |
      if [ 1 -eq "$(echo "${CI_DRUPAL_VERSION} >= 9.0" | bc)" ]; then
        composer require --no-ansi -n "phpspec/prophecy-phpunit";
      fi
    - echo -e "\e[0Ksection_end:`date +%s`:test_ci_prepare\r\e[0K"
